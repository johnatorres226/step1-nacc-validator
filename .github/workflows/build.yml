name: Build

on:
  push:
    branches: [ dev, codebase-curation ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-
    
    - name: Install dependencies
      run: poetry install --with dev
    
    - name: Clean build artifacts
      run: |
        rm -rf dist/ build/ *.egg-info
        echo "Cleaned previous build artifacts"
    
    - name: Build package
      run: poetry build
    
    - name: Check package contents
      run: |
        ls -la dist/
        echo "=== Checking wheel contents ==="
        python -m zipfile -l dist/*.whl | grep -i metadata || true
        echo ""
        echo "=== Extracting and inspecting METADATA ==="
        mkdir -p /tmp/wheel_inspection
        python -m zipfile -e dist/*.whl /tmp/wheel_inspection
        echo "First 30 lines of METADATA:"
        head -n 30 /tmp/wheel_inspection/udsv4_redcap_qc_validator-*.dist-info/METADATA || cat /tmp/wheel_inspection/udsv4_redcap_qc_validator-*.dist-info/METADATA || echo "Could not find METADATA file"
        echo ""
        echo "=== Using pkginfo to validate metadata ===" 
        pip install pkginfo
        python -c "import pkginfo; w = pkginfo.Wheel('dist/udsv4_redcap_qc_validator-0.1.0-py3-none-any.whl'); print(f'Name: {w.name}'); print(f'Version: {w.version}'); print(f'Summary: {w.summary}')"
    
    - name: Test package installation
      run: |
        pip install dist/*.whl
        udsv4-qc --version || echo \"Version command not available - skipping\"
      continue-on-error: true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distribution-packages
        path: dist/
        retention-days: 7