site: https://mermaid.live/

%% Data Routing Flowchart - Packet-Based Allocation with C2 Considerations
%% 
%% Key Components:
%% - PacketRuleRouter: Handles packet-based routing (I, I4, F)
%% - HierarchicalRuleResolver: Combines packet + dynamic instrument routing
%% - ConfigManager: Manages dynamic instrument configurations
%% 
%% Cache Keys Format: "packet_instrumentname" or "packet_instrumentname_discriminant"
%% Discriminant Variable: loc_c2_or_c2t (for C2/C2T neuropsychological battery)

flowchart TD
    A[REDCap Data Input] --> B[Record Packet Extraction<br/>PacketRuleRouter.get_rules_for_record]
    
    B --> B1{Packet Value Valid?}
    B1 -->|No| B2[ValueError: Missing/Invalid Packet<br/>Valid: I, I4, F]
    B1 -->|Yes| C{Packet Classification}
    
    C -->|packet = I| D[Initial Visit Rules<br/>Path: JSON_RULES_PATH_I]
    C -->|packet = I4| E[Initial Visit Form 4 Rules<br/>Path: JSON_RULES_PATH_I4]
    C -->|packet = F| F[Follow-up Visit Rules<br/>Path: JSON_RULES_PATH_F]
    
    D --> D1[Load packet-specific rules<br/>Cache Key: I_instrumentname]
    E --> E1[Load packet-specific rules<br/>Cache Key: I4_instrumentname]
    F --> F1[Load packet-specific rules<br/>Cache Key: F_instrumentname]
    
    D1 --> G{Instrument Type Check<br/>is_dynamic_rule_instrument}
    E1 --> G
    F1 --> G
    
    G -->|Standard Instrument| H[Direct Rule Loading<br/>instrument.json from packet path]
    G -->|Dynamic Instrument| I[C2/C2T Detection<br/>HierarchicalRuleResolver._apply_dynamic_routing]
    
    I --> I1[Extract Discriminant Variable<br/>loc_c2_or_c2t from record]
    I1 --> I2{Discriminant Value?}
    
    I2 -->|C2| I3[Load C2 Variant Rules<br/>c2_rules.json]
    I2 -->|C2T| I4[Load C2T Variant Rules<br/>c2t_rules.json]
    I2 -->|Missing/Invalid| I5[Use Default Variant<br/>First available variant]
    
    I3 --> J[Rule Resolution Complete<br/>Cache Key: packet_instrument_discriminant]
    I4 --> J
    I5 --> J
    H --> J
    
    J --> K[Apply Schema Validation<br/>Rule Application Engine]
    K --> L{Validation Pass?}
    
    L -->|Yes| M[Data Accepted<br/>Record Processed]
    L -->|No| N[Validation Errors<br/>Log to quality_check.log]
    
    B2 --> O[Error Handling<br/>Record Rejected]
    
    style B2 fill:#ff6b6b
    style I2 fill:#ffd93d
    style I fill:#6bcf7f
    style J fill:#4ecdc4
    style D fill:#e1f5fe
    style E fill:#e8f5e8
    style F fill:#fff3e0